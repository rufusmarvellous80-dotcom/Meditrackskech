<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MEDITRACK LIMITED Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <!-- jsPDF + autotable for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{--accent:#4f8ef7;--muted:#f7f7fa}
    body { font-family: Arial, sans-serif; background: var(--muted); margin:0; padding:1em; color:#222; }
    header{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:10px}
    h1{font-size:1.2rem;margin:0;color:#133}
    #date-today{font-size:0.95rem;color:#333}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .box{background:#fff;padding:0.65em;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}
    input[type="time"], input[type="date"], input[type="text"], input[type="password"] {
      padding:0.35em;border:1px solid #ccc;border-radius:6px;font-size:0.9rem;
    }
    button { background:var(--accent); color:#fff; border:none; padding:0.5em 0.8em; border-radius:8px; cursor:pointer; }
    button.secondary{background:#6c757d}
    button.ghost{background:transparent;border:1px solid #ddd;color:#333}
    .table-container{width:100%;overflow-x:auto;margin-top:10px}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden}
    th,td{padding:0.5em;text-align:center;border-bottom:1px solid #eee;font-size:0.88rem}
    th{background:var(--accent);color:#fff;font-weight:600}
    .status-message{font-weight:600;padding:0.2em;border-radius:6px;margin-top:4px;display:inline-block;font-size:0.78rem}
    .status-present{background:#e6ffe6;color:#1e7e34}
    .status-absent{background:#ffe6e6;color:#c82333}
    .status-on-leave{background:#e6f7ff;color:#005cbf}
    .status-late{background:#fffbe6;color:#d35400}
    .status-multi-late{background:#ffe6e6;color:#b8860b}
    .summary-stats{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    .stat{background:#fff;padding:0.6em;border-radius:10px;min-width:140px;text-align:left}
    .right{text-align:right}
    footer{margin-top:12px;text-align:center;color:#666;font-size:0.9rem}
    @media (max-width:768px){ header{flex-direction:column;align-items:flex-start} .controls{width:100%;} .stat{min-width:120px}}
    /* admin modal */
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:#fff;padding:1em;border-radius:12px;width:320px;max-width:95%}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>MEDITRACK LIMITED Janitor Attendance</h1>
      <div id="date-today">Date: <span id="current-date"></span></div>
    </div>

    <div class="controls">
      <div class="box">
        <input id="new-staff-name" type="text" placeholder="Add staff name" />
        <button id="add-staff-btn">Add</button>
      </div>

      <div class="box">
        <input id="search-name" type="text" placeholder="Search name" />
        <button id="search-btn" class="ghost">Search</button>
        <button id="clear-search-btn" class="ghost">Clear</button>
      </div>

      <div class="box">
        <button id="admin-login-btn" class="secondary">Admin Login</button>
      </div>
    </div>
  </header>

  <div class="table-container box">
    <table id="attendance-table" aria-label="Attendance table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Shift</th>
          <th>Time In</th>
          <th>Break Out</th>
          <th>Break In</th>
          <th>Time Out</th>
          <th>Hours</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <button id="mark-all-present">Mark All Present</button>
      <button id="mark-all-absent" class="ghost">Mark All Absent</button>
      <button id="clear-times" class="ghost">Clear Times</button>
      <button id="check-attendance" class="secondary">Check & Save Summary</button>

      <div style="flex:1"></div>

      <button id="export-csv" class="ghost">Export CSV</button>
      <button id="export-pdf" class="ghost">Export PDF</button>
      <button id="print-report" class="ghost">Print</button>
    </div>

    <div class="summary-stats" id="summary-stats" style="margin-top:10px"></div>
  </div>

  <div id="summary-section" class="box" style="margin-top:10px">
    <h3 style="margin-top:0">View Past Attendance Summaries</h3>
    <label for="summary-date">Date:</label>
    <input type="date" id="summary-date" />
    <button id="load-summary" class="ghost">Load</button>
    <div id="summary-output" style="margin-top:10px"></div>
  </div>

  <footer>
    <small>Client-only demo. For secure auth and biometric integration we recommend a backend service.</small>
  </footer>

  <!-- Admin modal -->
  <div class="modal-back" id="modal-back">
    <div class="modal box">
      <div id="modal-content">
        <h3>Admin Login</h3>
        <div style="margin-top:8px">
          <input id="admin-password" type="password" placeholder="Enter admin password" />
          <button id="admin-submit" style="margin-left:6px">Login</button>
        </div>
        <div id="admin-msg" style="margin-top:8px;color:#a00"></div>

        <div id="admin-panel" style="display:none;margin-top:10px">
          <h4>Admin Panel</h4>
          <div style="display:flex;gap:6px;align-items:center">
            <label>Change password</label>
            <input id="change-password-input" type="password" placeholder="new password" />
            <button id="change-password-btn">Change</button>
          </div>
          <div style="margin-top:8px;display:flex;gap:6px">
            <button id="logout-admin" class="ghost">Logout</button>
            <button id="close-modal" class="ghost">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---------- Configuration ----------
  const DEFAULT_ADMIN_PW = 'meditrack123'; // default; change via Admin Panel
  const EMAILJS_SERVICE = 'service_itxtkoc';
  const EMAILJS_TEMPLATE = 'template_mlh2ahf';
  const EMAILJS_USER = 'Wfz_vJ2NRT4YzMoJV'; // already used in your original script

  // ---------- EmailJS init ----------
  (function(){ if(window.emailjs) emailjs.init(EMAILJS_USER); })();

  // ---------- Initial staff ----------
  const initialStaffNames = [
    "Delight Vincent","Odekun Esther","Aribo Olufemi","Aluko joy","Awosanya Pelumi",
    "Temitayo Martins","Ibrahim Omotoyosi","Ouneyom Elizabeth","Otukelu Balikis",
    "Olarenwaju Fattimo","Kareem Muiz","Okeshola Segun","Misturah Disu","Idebe Lekan",
    "Belewu Fathia","Adegbenro Kudirat","Hussein Rosul","Shogbola Oluwaseun","Ogundowo Bose",
    "Tiamiyu Adijat","Adekunle Ronke","Anuoluwapo Joseph","Alabi Hassan","Adeshina Rashidat",
    "Amudat Lawal","Salvador Meminat","Lawal Dasola","Osinga Temitope","Sodiq Shukurat",
    "Ogunlusi Felicia","Afolabi Olawale","Iorhide Mariam","Adebayo Elijah"
  ];

  // ---------- State helpers ----------
  function loadStaff(){
    const raw = localStorage.getItem('meditrack_staff_list');
    if(!raw){
      localStorage.setItem('meditrack_staff_list', JSON.stringify(initialStaffNames));
      return [...initialStaffNames];
    }
    try { return JSON.parse(raw); } catch(e){ return [...initialStaffNames]; }
  }
  function saveStaff(list){ localStorage.setItem('meditrack_staff_list', JSON.stringify(list)); }
  function getAdminPass(){ return localStorage.getItem('meditrack_admin_pw') || DEFAULT_ADMIN_PW; }
  function setAdminPass(pw){ localStorage.setItem('meditrack_admin_pw', pw); }

  // ---------- Utilities ----------
  function el(tag, props={}, children=[]){ const e=document.createElement(tag); Object.assign(e,props); (children||[]).forEach(c=>e.appendChild(c)); return e; }
  function formatHM(minutes){
    if(isNaN(minutes)) return '-';
    const sign = minutes<0 ? '-' : '';
    minutes = Math.abs(Math.round(minutes));
    const h = Math.floor(minutes/60), m = minutes%60;
    return `${sign}${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
  }
  function minutesBetween(t1,t2){ // t1 and t2 "HH:MM"
    if(!t1||!t2) return NaN;
    const [h1,m1]=t1.split(':').map(Number), [h2,m2]=t2.split(':').map(Number);
    return (h2*60+m2)-(h1*60+m1);
  }
  function downloadFile(filename, content, mime='text/csv'){ const a=document.createElement('a'); const blob=new Blob([content],{type:mime}); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href); }

  // ---------- DOM references ----------
  const tbody = document.querySelector('#attendance-table tbody');
  const currentDateEl = document.getElementById('current-date');
  const summaryDateInput = document.getElementById('summary-date');
  const summaryOutput = document.getElementById('summary-output');
  const summaryStatsDiv = document.getElementById('summary-stats');

  // ---------- Initial rendering ----------
  let staffNames = loadStaff().sort((a,b)=>a.localeCompare(b));
  let adminLoggedIn = false;

  function setToday(){
    const today = new Date();
    const yyyy=today.getFullYear(), mm=String(today.getMonth()+1).padStart(2,'0'), dd=String(today.getDate()).padStart(2,'0');
    const todayStr=`${yyyy}-${mm}-${dd}`;
    currentDateEl.textContent = todayStr;
    summaryDateInput.value = todayStr;
  }
  setToday();

  function createStaffRow(name){
    const tr = document.createElement('tr');
    tr.setAttribute('data-name', name.toLowerCase());

    tr.innerHTML = `
      <td class="name-cell">${name}</td>
      <td>
        <select class="shift">
          <option value="morning">Morning</option>
          <option value="night">Night</option>
        </select>
      </td>
      <td><input type="time" class="time-in"></td>
      <td><input type="time" class="break-out"></td>
      <td><input type="time" class="break-in"></td>
      <td><input type="time" class="time-out"></td>
      <td class="hours-cell">-</td>
      <td>
        <select class="status">
          <option value="present">Present</option>
          <option value="absent">Absent</option>
          <option value="on-leave">On Leave</option>
        </select>
        <div class="status-message"></div>
      </td>
      <td><button class="delete-staff-btn ghost">Delete</button></td>
    `;

    // events to recalc on change
    ['change','input'].forEach(evt=>{
      tr.querySelectorAll('input, select').forEach(inp=>inp.addEventListener(evt, ()=>updateRow(tr)));
    });

    tr.querySelector('.delete-staff-btn').addEventListener('click', ()=>{
      if(!adminLoggedIn){ alert('Admin required to delete staff.'); return; }
      const nm = tr.querySelector('.name-cell').textContent;
      if(confirm(`Remove ${nm}?`)){
        staffNames = staffNames.filter(n=>n!==nm);
        saveStaff(staffNames);
        tr.remove();
        updateTotals();
      }
    });

    return tr;
  }

  function populateStaffTable(names){
    tbody.innerHTML='';
    names.forEach(name=>tbody.appendChild(createStaffRow(name)));
    updateTotals();
  }

  // Update a single row's status/hours
  function updateRow(tr){
    const shift = tr.querySelector('.shift').value;
    const timeIn = tr.querySelector('.time-in').value;
    const breakOut = tr.querySelector('.break-out').value;
    const breakIn = tr.querySelector('.break-in').value;
    const timeOut = tr.querySelector('.time-out').value;
    const statusSelect = tr.querySelector('.status');
    const statusMsgDiv = tr.querySelector('.status-message');

    // default absent when times empty and status not explicitly set
    if(statusSelect.value === 'absent' || (!timeIn && !timeOut && statusSelect.value !== 'on-leave')){
      statusSelect.value = 'absent';
      statusMsgDiv.textContent = 'Absent';
      statusMsgDiv.className = 'status-message status-absent';
      tr.querySelector('.hours-cell').textContent = '-';
      updateTotals();
      return;
    }

    if(statusSelect.value === 'on-leave'){
      statusMsgDiv.textContent = 'On Leave';
      statusMsgDiv.className = 'status-message status-on-leave';
      tr.querySelector('.hours-cell').textContent = '-';
      updateTotals();
      return;
    }

    // now compute lateness and hours
    let lateMessages = [];
    if(timeIn){
      // morning: expected 07:00-07:10; night: expected 17:00-17:10
      if(shift === 'morning'){
        if(minutesBetween('07:00', timeIn) > 10) lateMessages.push('Late to Work');
        // note: if earlier than 07:00 we still consider present; optionally flag early arrival if desired
      } else {
        if(minutesBetween('17:00', timeIn) > 10) lateMessages.push('Late to Work');
      }
    } else {
      lateMessages.push('No Time In');
    }

    if(breakOut){
      // simple checks (flexible)
      // morning break expected around 11:00-12:00
      if(shift === 'morning'){
        if(minutesBetween('11:00', breakOut) < 0 || minutesBetween(breakOut, '12:00') > 0) lateMessages.push('Late to Break');
      } else {
        // night break approx 23:00-00:00 (edge cases)
        // skip strict night break checks in this client demo
      }
    }

    if(breakIn && breakOut){
      // if took unusually long break
      const breakMinutes = minutesBetween(breakOut, breakIn);
      if(breakMinutes > 120) lateMessages.push('Long Break');
    }

    // hours calculation: timeOut - timeIn - breakDur (if both break times present)
    let workedMin = NaN;
    if(timeIn && timeOut){
      workedMin = minutesBetween(timeIn, timeOut);
      if(breakOut && breakIn){
        const bmin = minutesBetween(breakOut, breakIn);
        if(!isNaN(bmin)) workedMin -= bmin;
      }
    }

    // set status message
    if(lateMessages.length === 0 && !isNaN(workedMin)){
      tr.querySelector('.hours-cell').textContent = formatHM(workedMin);
      statusMsgDiv.textContent = 'Present';
      statusMsgDiv.className = 'status-message status-present';
      statusSelect.value = 'present';
    } else {
      // if no timeOut/timeIn treat absent
      if(isNaN(workedMin)){
        tr.querySelector('.hours-cell').textContent = '-';
      } else {
        tr.querySelector('.hours-cell').textContent = formatHM(workedMin);
      }
      const msg = lateMessages.join(' & ');
      statusMsgDiv.textContent = msg || 'Present';
      statusMsgDiv.className = lateMessages.length > 1 ? 'status-message status-multi-late' : 'status-message status-late';
      if(msg === '') statusSelect.value = 'present';
    }

    updateTotals();
  }

  function updateTotals(){
    const rows = Array.from(tbody.querySelectorAll('tr')).filter(r=>r.style.display !== 'none');
    let present = 0, absent = 0, onleave = 0, totalMinutes = 0;
    rows.forEach(r=>{
      const status = r.querySelector('.status').value;
      if(status === 'present') present++;
      else if(status === 'absent') absent++;
      else if(status === 'on-leave') onleave++;
      const hm = r.querySelector('.hours-cell').textContent;
      if(hm && hm !== '-' && hm.indexOf(':')>0){
        const [h,m] = hm.split(':').map(Number);
        totalMinutes += (h*60+m);
      }
    });

    summaryStatsDiv.innerHTML = '';
    const statPresent = el('div',{className:'stat'}, [document.createTextNode(`Present: ${present}`)]);
    const statAbsent = el('div',{className:'stat'}, [document.createTextNode(`Absent: ${absent}`)]);
    const statOnLeave = el('div',{className:'stat'}, [document.createTextNode(`On Leave: ${onleave}`)]);
    const statTotalHours = el('div',{className:'stat'}, [document.createTextNode(`Total Hours: ${formatHM(totalMinutes)}`)]);
    summaryStatsDiv.appendChild(statPresent);
    summaryStatsDiv.appendChild(statAbsent);
    summaryStatsDiv.appendChild(statOnLeave);
    summaryStatsDiv.appendChild(statTotalHours);
  }

  // ---------- Save / Load summaries ----------
  function saveAttendanceSummary(dateStr, summaryData){
    let all = JSON.parse(localStorage.getItem('attendanceSummaries')||'{}');
    all[dateStr] = summaryData;
    localStorage.setItem('attendanceSummaries', JSON.stringify(all));
  }
  function loadAttendanceSummary(dateStr){
    let all = JSON.parse(localStorage.getItem('attendanceSummaries')||'{}');
    return all[dateStr] || null;
  }

  function collectCurrentSummary(){
    const rows = Array.from(tbody.querySelectorAll('tr')).filter(r=>r.style.display!=='none');
    const data = rows.map(r=>{
      return {
        name: r.querySelector('.name-cell').textContent,
        shift: r.querySelector('.shift').value,
        timeIn: r.querySelector('.time-in').value || '',
        breakOut: r.querySelector('.break-out').value || '',
        breakIn: r.querySelector('.break-in').value || '',
        timeOut: r.querySelector('.time-out').value || '',
        hours: r.querySelector('.hours-cell').textContent || '',
        status: r.querySelector('.status-message').textContent || ''
      };
    });
    return data;
  }

  function checkAndSaveAttendance(auto=false){
    // update all rows then save
    tbody.querySelectorAll('tr').forEach(tr=>updateRow(tr));

    const today = new Date();
    const yyyy=today.getFullYear(), mm=String(today.getMonth()+1).padStart(2,'0'), dd=String(today.getDate()).padStart(2,'0');
    const todayStr=`${yyyy}-${mm}-${dd}`;

    const summaryData = collectCurrentSummary();
    saveAttendanceSummary(todayStr, summaryData);

    // send email if admin logged in; avoid duplicate sends
    const sentKey = `summarySentForDate_${todayStr}`;
    if(localStorage.getItem(sentKey) && !auto) {
      alert('Summary already sent for today.');
      return;
    }

    if(adminLoggedIn){
      // build summaryText
      const summaryText = summaryData.map(item=>
        `Name: ${item.name}\nShift: ${item.shift}\nTime In: ${item.timeIn||'-'}\nTime Out: ${item.timeOut||'-'}\nBreak Out: ${item.breakOut||'-'}\nBreak In: ${item.breakIn||'-'}\nHours: ${item.hours||'-'}\nStatus: ${item.status || '-'}`
      ).join("\n\n");

      emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE, { to_email: "dejalizzy25@gmail.com", date: todayStr, summary: summaryText })
      .then(()=>{ if(!auto) alert('Attendance summary sent!'); localStorage.setItem(sentKey, '1'); })
      .catch(err=>{ if(!auto) alert('Failed to send email: '+JSON.stringify(err)); });
    } else {
      if(!auto) alert('Summary saved locally. (Admin required to send email.)');
      localStorage.setItem(sentKey, '1'); // still mark saved to avoid duplicate local sends
    }
  }

  // ---------- Export CSV ----------
  function exportCSV(){
    const rows = Array.from(tbody.querySelectorAll('tr')).filter(r=>r.style.display!=='none');
    const headers = ['Name','Shift','Time In','Break Out','Break In','Time Out','Hours','Status'];
    const lines = [headers.join(',')];
    rows.forEach(r=>{
      const cells = [
        `"${r.querySelector('.name-cell').textContent}"`,
        r.querySelector('.shift').value,
        r.querySelector('.time-in').value || '-',
        r.querySelector('.break-out').value || '-',
        r.querySelector('.break-in').value || '-',
        r.querySelector('.time-out').value || '-',
        r.querySelector('.hours-cell').textContent || '-',
        `"${r.querySelector('.status-message').textContent || '-'}"`
      ];
      lines.push(cells.join(','));
    });
    const today = currentDateEl.textContent.replace(/-/g,'');
    downloadFile(`attendance_${today}.csv`, lines.join('\n'), 'text/csv');
  }

  // ---------- Export PDF ----------
  async function exportPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({orientation:'portrait',unit:'pt',format:'a4'});
    doc.setFontSize(12);
    doc.text(`MEDITRACK LIMITED - Attendance (${currentDateEl.textContent})`, 40, 40);

    // collect table data
    const rows = Array.from(tbody.querySelectorAll('tr')).filter(r=>r.style.display!=='none');
    const tableData = rows.map(r=>[
      r.querySelector('.name-cell').textContent,
      r.querySelector('.shift').value,
      r.querySelector('.time-in').value || '-',
      r.querySelector('.break-out').value || '-',
      r.querySelector('.break-in').value || '-',
      r.querySelector('.time-out').value || '-',
      r.querySelector('.hours-cell').textContent || '-',
      r.querySelector('.status-message').textContent || '-'
    ]);

    doc.autoTable({
      head: [['Name','Shift','In','Break Out','Break In','Out','Hours','Status']],
      body: tableData,
      startY: 60,
      styles: { fontSize: 9 }
    });

    doc.save(`attendance_${currentDateEl.textContent}.pdf`);
  }

  // ---------- Print ----------
  function printReport(){
    // Build printable HTML in new window
    const rows = Array.from(tbody.querySelectorAll('tr')).filter(r=>r.style.display!=='none');
    let html = `<html><head><title>Attendance - ${currentDateEl.textContent}</title>
      <style>body{font-family:Arial;font-size:12px}table{border-collapse:collapse;width:100%}th,td{border:1px solid #ccc;padding:6px;text-align:center}th{background:#eee}</style>
      </head><body><h2>MEDITRACK LIMITED - Attendance (${currentDateEl.textContent})</h2><table><thead><tr><th>Name</th><th>Shift</th><th>In</th><th>Break Out</th><th>Break In</th><th>Out</th><th>Hours</th><th>Status</th></tr></thead><tbody>`;
    rows.forEach(r=>{
      html += `<tr><td>${r.querySelector('.name-cell').textContent}</td><td>${r.querySelector('.shift').value}</td><td>${r.querySelector('.time-in').value||'-'}</td><td>${r.querySelector('.break-out').value||'-'}</td><td>${r.querySelector('.break-in').value||'-'}</td><td>${r.querySelector('.time-out').value||'-'}</td><td>${r.querySelector('.hours-cell').textContent||'-'}</td><td>${r.querySelector('.status-message').textContent||'-'}</td></tr>`;
    });
    html += `</tbody></table></body></html>`;
    const w = window.open('', '_blank');
    w.document.write(html);
    w.document.close();
    w.focus();
    w.print();
  }

  // ---------- Load summary to view ----------
  document.getElementById('load-summary').addEventListener('click', ()=>{
    const dateStr = summaryDateInput.value;
    if(!dateStr){ alert('Choose a date'); return; }
    const data = loadAttendanceSummary(dateStr);
    if(!data){ summaryOutput.innerHTML = '<em>No attendance summary for this date.</em>'; return; }
    let html = '<table style="width:100%;border-collapse:collapse"><thead><tr><th>Name</th><th>Shift</th><th>In</th><th>Break Out</th><th>Break In</th><th>Out</th><th>Hours</th><th>Status</th></tr></thead><tbody>';
    data.forEach(item=>{
      html += `<tr><td>${item.name}</td><td>${item.shift}</td><td>${item.timeIn||'-'}</td><td>${item.breakOut||'-'}</td><td>${item.breakIn||'-'}</td><td>${item.timeOut||'-'}</td><td>${item.hours||'-'}</td><td>${item.status||'-'}</td></tr>`;
    });
    html += '</tbody></table>';
    summaryOutput.innerHTML = html;
  });

  // ---------- Event bindings ----------
  document.getElementById('add-staff-btn').addEventListener('click', ()=>{
    const input = document.getElementById('new-staff-name');
    const name = input.value.trim();
    if(!name){ alert('Enter a staff name'); return; }
    if(staffNames.includes(name)){ alert('Staff already exists'); return; }
    staffNames.push(name); staffNames.sort((a,b)=>a.localeCompare(b));
    saveStaff(staffNames);
    populateStaffTable(staffNames);
    input.value = '';
  });

  document.getElementById('search-btn').addEventListener('click', ()=>{
    const q = document.getElementById('search-name').value.trim().toLowerCase();
    tbody.querySelectorAll('tr').forEach(row=>{
      row.style.display = (!q || row.getAttribute('data-name').includes(q)) ? '' : 'none';
    });
    updateTotals();
  });
  document.getElementById('clear-search-btn').addEventListener('click', ()=>{
    document.getElementById('search-name').value = '';
    tbody.querySelectorAll('tr').forEach(row=>row.style.display='');
    updateTotals();
  });

  document.getElementById('mark-all-present').addEventListener('click', ()=>{
    tbody.querySelectorAll('tr').forEach(tr=>{
      tr.querySelector('.status').value='present';
      const now = new Date();
      // set default in/out times if empty depending on shift
      if(!tr.querySelector('.time-in').value){
        tr.querySelector('.time-in').value = tr.querySelector('.shift').value === 'morning' ? '07:00' : '17:00';
      }
      if(!tr.querySelector('.time-out').value){
        tr.querySelector('.time-out').value = tr.querySelector('.shift').value === 'morning' ? '17:00' : '07:00';
      }
      updateRow(tr);
    });
    updateTotals();
  });

  document.getElementById('mark-all-absent').addEventListener('click', ()=>{
    if(!confirm('Mark all visible staff as absent?')) return;
    tbody.querySelectorAll('tr').forEach(tr=>{
      tr.querySelector('.status').value='absent';
      tr.querySelector('.status-message').textContent='Absent';
      tr.querySelector('.status-message').className='status-message status-absent';
      tr.querySelector('.time-in').value = '';
      tr.querySelector('.time-out').value = '';
      tr.querySelector('.break-in').value = '';
      tr.querySelector('.break-out').value = '';
      tr.querySelector('.hours-cell').textContent = '-';
    });
    updateTotals();
  });

  document.getElementById('clear-times').addEventListener('click', ()=>{
    tbody.querySelectorAll('tr').forEach(tr=>{
      tr.querySelectorAll('input[type=time]').forEach(inp=>inp.value='');
      updateRow(tr);
    });
    updateTotals();
  });

  document.getElementById('check-attendance').addEventListener('click', ()=>checkAndSaveAttendance(false));
  document.getElementById('export-csv').addEventListener('click', ()=> {
    if(!adminLoggedIn){ alert('Admin required to export.'); return; }
    exportCSV();
  });
  document.getElementById('export-pdf').addEventListener('click', ()=> {
    if(!adminLoggedIn){ alert('Admin required to export.'); return; }
    exportPDF();
  });
  document.getElementById('print-report').addEventListener('click', ()=> printReport());

  // ---------- Admin modal logic ----------
  const modalBack = document.getElementById('modal-back');
  const adminLoginBtn = document.getElementById('admin-login-btn');
  const adminSubmit = document.getElementById('admin-submit');
  const adminPasswordInput = document.getElementById('admin-password');
  const adminMsg = document.getElementById('admin-msg');
  const adminPanelDiv = document.getElementById('admin-panel');
  const changePwBtn = document.getElementById('change-password-btn');
  const changePwInput = document.getElementById('change-password-input');
  const logoutAdminBtn = document.getElementById('logout-admin');
  const closeModalBtn = document.getElementById('close-modal');

  adminLoginBtn.addEventListener('click', ()=> { modalBack.style.display='flex'; adminMsg.textContent=''; adminPasswordInput.value=''; adminPanelDiv.style.display='none'; document.getElementById('modal-content').scrollIntoView(); });

  adminSubmit.addEventListener('click', ()=>{
    const pw = adminPasswordInput.value || '';
    if(pw === getAdminPass()){
      adminLoggedIn = true;
      adminMsg.style.color = 'green';
      adminMsg.textContent = 'Admin logged in.';
      adminPanelDiv.style.display = 'block';
      // show admin controls enabled
    } else {
      adminMsg.style.color = 'red';
      adminMsg.textContent = 'Wrong password';
    }
  });

  changePwBtn.addEventListener('click', ()=>{
    const newpw = changePwInput.value.trim();
    if(!newpw){ alert('Enter new password'); return; }
    setAdminPass(newpw);
    alert('Admin password changed locally.');
    changePwInput.value='';
  });

  logoutAdminBtn.addEventListener('click', ()=>{
    adminLoggedIn = false;
    adminMsg.style.color='black';
    adminMsg.textContent='Logged out.';
    adminPanelDiv.style.display='none';
  });

  closeModalBtn.addEventListener('click', ()=> modalBack.style.display='none');
  modalBack.addEventListener('click', (e)=>{ if(e.target === modalBack) modalBack.style.display='none'; });

  // ---------- Auto-send at 07:00 (client-only) ----------
  setInterval(()=>{
    const now=new Date();
    if(now.getHours()===7 && now.getMinutes()===0){
      checkAndSaveAttendance(true);
    }
  },30000);

  // ---------- Init table on load ----------
  populateStaffTable(staffNames);

  // ensure updateRow called after initial rows added
  tbody.querySelectorAll('tr').forEach(tr=>updateRow(tr));

  // small safety: persist staff when page closes
  window.addEventListener('beforeunload', ()=> saveStaff(staffNames));

  // ---------- Keyboard niceties: Enter adds staff ----------
  document.getElementById('new-staff-name').addEventListener('keydown', e=>{ if(e.key==='Enter'){ document.getElementById('add-staff-btn').click(); }});
</script>
</body>
</html>